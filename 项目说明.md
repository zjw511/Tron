# ComfyUI 简化版 - 项目说明

> 项目结构、状态和技术说明

## 📁 项目结构

### 核心文件（必需）

| 文件 | 大小 | 说明 | 状态 |
|------|------|------|------|
| `full_server.py` | 21.1 KB | 完整功能服务器 | ✅ 推荐使用 |
| `nodes.py` | 11.9 KB | 节点定义系统 | ✅ 必需 |
| `requirements.txt` | 0.3 KB | Python依赖 | ✅ 必需 |
| `START_FULL.bat` | 0.3 KB | 快速启动脚本 | ✅ 推荐 |

### 备用文件（可选）

| 文件 | 大小 | 说明 | 用途 |
|------|------|------|------|
| `simple_server.py` | 22.1 KB | 简化版服务器 | 学习理解 |
| `modular_server.py` | 20.3 KB | 模块化服务器 | 开发调试 |
| `start_modular.bat` | 0.3 KB | 模块化启动 | 备用启动 |

### 文档文件

| 文件 | 说明 |
|------|------|
| `README.md` | 快速开始指南 |
| `使用指南.md` | 详细使用说明 |
| `项目说明.md` | 本文件 - 项目总览 |
| `FULL_FEATURES.md` | 完整功能文档（英文） |

### 目录结构

```
simple_comfyui/
├── 核心文件
│   ├── full_server.py          # 主服务器 ⭐
│   ├── nodes.py                # 节点系统
│   ├── requirements.txt        # 依赖
│   └── START_FULL.bat          # 启动脚本
│
├── 备用文件
│   ├── simple_server.py        # 简化版
│   ├── modular_server.py       # 模块化版
│   └── start_modular.bat       # 备用启动
│
├── 文档
│   ├── README.md               # 快速开始
│   ├── 使用指南.md             # 使用说明
│   ├── 项目说明.md             # 本文件
│   └── FULL_FEATURES.md        # 功能文档
│
└── 数据目录
    ├── input/                  # 输入图片（3个文件）
    ├── output/                 # 输出结果
    └── temp/                   # 临时预览
```

## 🚀 快速开始

### 启动服务器

```bash
# 方法1：双击启动
START_FULL.bat

# 方法2：命令行
python full_server.py
```

### 访问地址

```
http://127.0.0.1:8188
```

## ✨ 功能特点

### full_server.py 包含

#### ✅ 完整的节点系统

- **12个节点类型**
  - LoadImage, SaveImage, ImageScale
  - PreviewImage（WebSocket实时预览）
  - PrimitiveFloat, PrimitiveString
  - LatentBlend, VAEDecode
  - PreviewAny, Reroute, Note, MarkdownNote

- **模块化设计**
  - 使用`nodes.py`定义节点
  - 自动注册到系统
  - 易于扩展

#### ✅ 拓扑排序执行引擎

- 自动按依赖关系排序节点
- 智能数据传递
- 循环依赖检测
- PIL Image对象直接传递

#### ✅ WebSocket实时通信

- 实时连接管理
- 广播消息系统
- `executed`事件推送
- 图片预览实时显示

#### ✅ 图片预览功能

- `/view` API查看图片
- 支持三个目录（input/output/temp）
- 子文件夹支持
- 安全路径检查

#### ✅ 23个完整API端点

**核心API (9个):**
- `/prompt`, `/object_info`, `/queue`
- `/history`, `/embeddings`, `/extensions`
- `/system_stats`, `/ws`

**用户API (6个):**
- `/users`, `/user_config`, `/settings`
- `/settings/{key}`, `/userdata`

**其他API (8个):**
- `/api/i18n`, `/api/experiment/models`
- `/api/workflows`, `/api/entities`
- `/manifest.json`, `/user.css`, `/view`

#### ✅ 错误处理和日志

- 完整的异常捕获
- 详细的执行日志
- 错误追踪和堆栈
- WebSocket状态监控

#### ✅ 历史记录管理

- 保存工作流执行历史
- 查询特定历史记录
- 支持多个工作流

#### ✅ 中文界面支持

- `/api/i18n`端点
- 中文节点名称
- 中文界面元素

## 📊 版本对比

### full_server.py（推荐）

**优势：**
- ✅ 完整功能
- ✅ 使用nodes.py模块化节点
- ✅ WebSocket实时通信
- ✅ 拓扑排序执行
- ✅ 详细日志
- ✅ 错误处理
- ✅ 历史记录

**适用场景：**
- 生产使用
- 完整功能需求
- 长期项目

**文件大小：** 21.1 KB

### simple_server.py（备用）

**特点：**
- ⚠️ 简化版本
- ⚠️ 硬编码节点
- ⚠️ 部分功能
- ✅ 代码简单

**适用场景：**
- 学习理解
- 快速原型
- 教学演示

**文件大小：** 22.1 KB

### modular_server.py（备用）

**特点：**
- ✅ 模块化设计
- ✅ 包含调试功能
- ✅ 详细日志
- ⚠️ 可能有实验性功能

**适用场景：**
- 开发调试
- 功能测试
- 问题排查

**文件大小：** 20.3 KB

## 🔧 技术栈

### 后端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.11+ | 主要语言 |
| aiohttp | latest | 异步Web服务器 |
| Pillow | latest | 图片处理 |
| asyncio | 内置 | 异步IO |

### 前端技术

| 技术 | 说明 |
|------|------|
| comfyui_frontend_package | ComfyUI官方前端 |
| LiteGraph.js | 节点编辑器 |
| WebSocket | 实时通信 |
| Vue.js | 前端框架（包内） |

### 架构设计

```
┌─────────────┐
│   浏览器     │
│  (前端界面)  │
└──────┬──────┘
       │ HTTP/WebSocket
       ↓
┌─────────────┐
│  aiohttp    │
│  (Web服务器) │
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ full_server │
│  (业务逻辑)  │
└──────┬──────┘
       │
       ↓
┌─────────────┐
│   nodes.py  │
│  (节点系统)  │
└──────┬──────┘
       │
       ↓
┌─────────────┐
│   Pillow    │
│  (图片处理)  │
└─────────────┘
```

## 📝 已清理的文件

### 删除的调试文件（7个）

| 文件 | 原因 |
|------|------|
| `403_FORBIDDEN_FIXED.txt` | 调试文档，已解决 |
| `API_DATA_STRUCTURE_FIXED.txt` | 调试文档，已解决 |
| `SETTINGS_API_FIXED.txt` | 调试文档，已解决 |
| `STATIC_ROUTING_FIXED.txt` | 调试文档，已解决 |
| `server.py` | 旧版本服务器 |
| `run_and_check.ps1` | 旧测试脚本 |
| `node_template.py` | 已在文档说明 |

### 保留的文件

**核心文件：** 保留所有必需文件  
**备用文件：** 保留以防需要  
**文档文件：** 转换为Markdown格式

## 💡 使用建议

### 日常使用

```bash
# 推荐使用
python full_server.py

# 或双击
START_FULL.bat
```

### 学习代码

1. 阅读 `simple_server.py`（更简单）
2. 阅读 `nodes.py`（节点系统）
3. 阅读 `full_server.py`（完整功能）

### 开发调试

```bash
# 使用模块化版本
python modular_server.py

# 查看详细日志
```

### 添加节点

1. 在`nodes.py`中添加节点类
2. 重启服务器
3. 前端自动识别新节点

## 📖 文档阅读顺序

### 快速上手

1. **README.md** - 5分钟快速了解
2. **START_FULL.bat** - 一键启动

### 深入学习

1. **使用指南.md** - 详细使用方法
2. **FULL_FEATURES.md** - 完整功能说明
3. **项目说明.md** - 本文件

### 开发扩展

1. 阅读 `nodes.py` 源码
2. 参考文档中的示例
3. 添加自定义节点

## ⚠️ 重要提示

### 不要删除

- `full_server.py` - 核心服务器
- `nodes.py` - 节点系统
- `requirements.txt` - 依赖列表
- `input/` 目录 - 输入图片

### 可以删除（如果不需要）

- `simple_server.py` - 简化版（有full_server即可）
- `modular_server.py` - 模块化版（有full_server即可）
- `start_modular.bat` - 备用启动（有START_FULL即可）

### 定期清理

- `temp/` 目录 - 临时预览文件
- `output/` 目录 - 旧的输出文件

## 🎯 项目状态

### ✅ 已完成

- [x] 完整的节点系统
- [x] 拓扑排序执行引擎
- [x] WebSocket实时通信
- [x] 图片预览功能
- [x] 所有API端点
- [x] 错误处理和日志
- [x] 历史记录管理
- [x] 中文界面支持
- [x] 完整文档（Markdown）
- [x] 项目清理

### 🔄 当前状态

- **服务器：** 运行中 ✅
- **地址：** http://127.0.0.1:8188
- **功能：** 完整可用 ✅
- **文档：** 完善 ✅

### 🚀 可能的扩展

- [ ] GPU支持（CUDA/MPS）
- [ ] 真实AI模型加载
- [ ] 队列管理系统
- [ ] 数据库持久化
- [ ] 多用户支持
- [ ] 插件系统
- [ ] 性能优化

## 📞 技术支持

### 遇到问题？

1. **查看文档**
   - README.md
   - 使用指南.md
   - FULL_FEATURES.md

2. **检查日志**
   - 服务器控制台
   - 浏览器Console（F12）

3. **常见问题**
   - 端口占用 → 停止旧进程
   - 页面空白 → 强制刷新
   - 图片不显示 → 检查路径

### 调试技巧

```bash
# 查看服务器日志
python full_server.py

# 查看端口占用
netstat -ano | findstr :8188

# 停止Python进程
Get-Process python | Stop-Process -Force
```

## 📊 统计信息

### 代码统计

| 文件 | 行数 | 大小 |
|------|------|------|
| full_server.py | ~615行 | 21.1 KB |
| nodes.py | ~396行 | 11.9 KB |
| simple_server.py | ~671行 | 22.1 KB |
| modular_server.py | ~642行 | 20.3 KB |

### 功能统计

- **节点类型：** 12个
- **API端点：** 23个
- **支持格式：** PNG, JPG, JPEG, BMP, GIF
- **WebSocket：** 实时双向通信

---

**项目整理完成！** ✅  
**所有文档已转换为Markdown格式！** 📝  
**祝使用愉快！** 🎉

