# è°ƒè¯•è¡¨æ ¼æ˜¾ç¤º

## ğŸ” å®æ—¶è°ƒè¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡å™¨å¹¶è¿è¡Œå·¥ä½œæµ

å¯åŠ¨æœåŠ¡å™¨åï¼Œåˆ›å»ºå·¥ä½œæµï¼š
```
LoadCSV â†’ PreviewTable
```

é…ç½®LoadCSVï¼š
- `file_path`: `examples/sample_data.csv`

ç‚¹å‡» **Queue Prompt**

### 2. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰

åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—åºåˆ—ï¼š

#### âœ… æ­£å¸¸æµç¨‹ï¼š

```javascript
// 1. æ‰©å±•åŠ è½½
[TablePreview] Loading table preview extension...
[TablePreview] ComfyUI loaded, registering extension...
[TablePreview] Using direct monitoring  // æˆ– Using event-based API
[TablePreview] WebSocket monitoring active

// 2. WebSocketæ¶ˆæ¯ï¼ˆä¼šæœ‰å¾ˆå¤šç±»å‹çš„æ¶ˆæ¯ï¼‰
[TablePreview] WS message type: status {...}
[TablePreview] WS message type: execution_start {...}
[TablePreview] WS message type: executing {...}

// 3. å…³é”®ï¼šæ‰§è¡Œå®Œæˆæ¶ˆæ¯
[TablePreview] WS message type: executed {type: "executed", data: {...}}
[TablePreview] Execution message: {type: "executed", data: {node: "2", output: {table: [...]}, prompt_id: "..."}}
[TablePreview] Output data: {table: [...]}
[TablePreview] âœ“ Found table data: [{id: "...", title: "...", columns: [...], data: [...]}]

// 4. è¡¨æ ¼åº”è¯¥å¼¹å‡ºï¼
```

### 3. å¦‚æœçœ‹åˆ° "âœ— No table data"

```javascript
[TablePreview] âœ— No table data in output
[TablePreview]   output: {...}
[TablePreview]   output.table: undefined
```

**è¿™æ„å‘³ç€**ï¼šoutputå¯¹è±¡ä¸­æ²¡æœ‰tableå­—æ®µã€‚

#### è°ƒè¯•æ­¥éª¤ï¼š

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰‹åŠ¨æ£€æŸ¥ï¼š
```javascript
// å¤åˆ¶æœ€è¿‘çš„ Execution message å¯¹è±¡ï¼Œç„¶åè¿è¡Œï¼š
let msg = {type: "executed", data: {...}};  // ç²˜è´´ä½ çœ‹åˆ°çš„æ¶ˆæ¯
console.log('data:', msg.data);
console.log('output:', msg.data.output);
console.log('table:', msg.data.output?.table);
```

### 4. æ£€æŸ¥åç«¯æ—¥å¿—

æœåŠ¡å™¨æ§åˆ¶å°åº”è¯¥æ˜¾ç¤ºï¼š

```
[*] Executing node 1: LoadCSV
    [OK] Loaded CSV: 10 rows Ã— 5 cols
[*] Executing node 2: PreviewTable  
    [OK] Preview table: 10 rows Ã— 5 cols
[OK] Node 2 executed successfully
[>>] Sending WebSocket message for node 2
```

**å…³é”®**ï¼šå¿…é¡»çœ‹åˆ° "Sending WebSocket message"

### 5. å¦‚æœæ²¡æœ‰ "Sending WebSocket message"

è¿™æ„å‘³ç€èŠ‚ç‚¹æ²¡æœ‰è¿”å›UIæ•°æ®ã€‚æ£€æŸ¥ï¼š

```python
# åœ¨table_nodes.pyçš„PreviewTable.executeæ–¹æ³•
return {
    "ui": {
        "table": [table_json]  # â† è¿™ä¸ªå¿…é¡»å­˜åœ¨
    }
}
```

## ğŸ› å¸¸è§é—®é¢˜å®šä½

### é—®é¢˜A: æ²¡æœ‰WebSocketæ¶ˆæ¯

**ç—‡çŠ¶**ï¼šåªçœ‹åˆ°åŠ è½½æ—¥å¿—ï¼Œæ²¡æœ‰ä»»ä½•WS message

**åŸå› **ï¼šWebSocketæœªè¿æ¥

**æ£€æŸ¥**ï¼š
1. æµè§ˆå™¨æ§åˆ¶å° â†’ Network â†’ WSæ ‡ç­¾
2. åº”è¯¥çœ‹åˆ° `ws://127.0.0.1:8188/ws` è¿æ¥
3. çŠ¶æ€åº”è¯¥æ˜¯ "Connected"

### é—®é¢˜B: æœ‰executedæ¶ˆæ¯ä½†æ²¡æœ‰table

**ç—‡çŠ¶**ï¼š
```
[TablePreview] Execution message: {type: "executed", data: {output: {}}}
[TablePreview] âœ— No table data
```

**åŸå› **ï¼šèŠ‚ç‚¹è¿”å›çš„UIæ•°æ®ä¸ºç©º

**è§£å†³**ï¼š
1. æ£€æŸ¥åç«¯æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯
2. ç¡®è®¤PreviewTableèŠ‚ç‚¹æ­£ç¡®æ¥æ”¶æ•°æ®
3. æ£€æŸ¥`_to_dataframe`æ˜¯å¦æˆåŠŸè½¬æ¢

### é—®é¢˜C: æ•°æ®æ ¼å¼é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
[TablePreview] âœ“ Found table data: undefined
```

**åŸå› **ï¼štableæ•°ç»„ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯

**æ£€æŸ¥**ï¼šåœ¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
// å‡è®¾msgæ˜¯Execution message
console.log(msg.data.output.table);
console.log(msg.data.output.table[0]);  // åº”è¯¥æ˜¯è¡¨æ ¼æ•°æ®å¯¹è±¡
```

## ğŸ§ª æ‰‹åŠ¨æµ‹è¯• WebSocket

åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š

```javascript
// 1. ç›‘å¬æ‰€æœ‰WebSocketæ¶ˆæ¯
const originalWS = window.WebSocket;
window.WebSocket = function(url, protocols) {
    const ws = new originalWS(url, protocols);
    ws.addEventListener('message', (e) => {
        try {
            const data = JSON.parse(e.data);
            if (data.type === 'executed') {
                console.log('=== EXECUTED MESSAGE ===');
                console.log('Full:', data);
                console.log('Node:', data.data.node);
                console.log('Output:', data.data.output);
                console.log('Table:', data.data.output?.table);
                console.log('=======================');
            }
        } catch(e) {}
    });
    return ws;
};

// 2. ç„¶ååˆ·æ–°é¡µé¢ï¼Œé‡æ–°è¿è¡Œå·¥ä½œæµ
```

## ğŸ“Š é¢„æœŸæ•°æ®ç»“æ„

### WebSocketæ¶ˆæ¯æ ¼å¼ï¼š

```json
{
  "type": "executed",
  "data": {
    "node": "2",
    "output": {
      "table": [
        {
          "id": "uuid",
          "title": "Data Table",
          "columns": ["Name", "Age", "City", "Salary", "Department"],
          "data": [
            ["Alice", 28, "New York", 75000, "Engineering"],
            ["Bob", 35, "San Francisco", 95000, "Engineering"]
          ],
          "shape": [10, 5],
          "dtypes": {"Name": "object", "Age": "int64", ...},
          "truncated": false,
          "total_rows": 10
        }
      ]
    },
    "prompt_id": "prompt-..."
  }
}
```

### èŠ‚ç‚¹è¿”å›æ ¼å¼ï¼ˆåç«¯ï¼‰ï¼š

```python
return {
    "ui": {
        "table": [table_json]
    }
}
```

## ğŸ”§ ä¸´æ—¶ä¿®å¤æµ‹è¯•

å¦‚æœè¿˜æ˜¯ä¸æ˜¾ç¤ºï¼Œåœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰‹åŠ¨è§¦å‘ï¼š

```javascript
// åˆ›å»ºæµ‹è¯•æ•°æ®
const testTable = {
    id: "test",
    title: "Test Table",
    columns: ["A", "B", "C"],
    data: [[1, 2, 3], [4, 5, 6]],
    shape: [2, 3],
    dtypes: {"A": "int", "B": "int", "C": "int"},
    truncated: false,
    total_rows: 2
};

// æ‰‹åŠ¨è°ƒç”¨æ˜¾ç¤ºå‡½æ•°ï¼ˆéœ€è¦æ‰©å±•å·²åŠ è½½ï¼‰
// åœ¨æ§åˆ¶å°åº”è¯¥èƒ½æ‰¾åˆ°showTableModalå‡½æ•°
// å¦‚æœä¸èƒ½ï¼Œè¯´æ˜æ‰©å±•ä½œç”¨åŸŸé—®é¢˜

// ä¸´æ—¶è§£å†³ï¼šç›´æ¥æ³¨å…¥æ˜¾ç¤ºä»£ç 
(function() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1e1e1e;padding:20px;z-index:10000;border:2px solid #444;';
    modal.innerHTML = '<h3 style="color:#fff;">Test Table</h3><pre style="color:#fff;">' + JSON.stringify(testTable, null, 2) + '</pre>';
    document.body.appendChild(modal);
    modal.onclick = () => modal.remove();
})();
```

## âœ… æˆåŠŸæ ‡å¿—

å½“ä¸€åˆ‡æ­£å¸¸æ—¶ï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

1. âœ… æ‰©å±•åŠ è½½æˆåŠŸ
2. âœ… WebSocketè¿æ¥å»ºç«‹
3. âœ… æ”¶åˆ°executedæ¶ˆæ¯
4. âœ… æ‰¾åˆ°tableæ•°æ®
5. âœ… è¡¨æ ¼å¼¹çª—è‡ªåŠ¨æ˜¾ç¤º
6. âœ… æ•°æ®æ­£ç¡®æ¸²æŸ“

---

**å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´è¾“å‡ºï¼**

