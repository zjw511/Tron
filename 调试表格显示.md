# 调试表格显示

## 🔍 实时调试步骤

### 1. 启动服务器并运行工作流

启动服务器后，创建工作流：
```
LoadCSV → PreviewTable
```

配置LoadCSV：
- `file_path`: `examples/sample_data.csv`

点击 **Queue Prompt**

### 2. 查看浏览器控制台（F12）

应该看到以下日志序列：

#### ✅ 正常流程：

```javascript
// 1. 扩展加载
[TablePreview] Loading table preview extension...
[TablePreview] ComfyUI loaded, registering extension...
[TablePreview] Using direct monitoring  // 或 Using event-based API
[TablePreview] WebSocket monitoring active

// 2. WebSocket消息（会有很多类型的消息）
[TablePreview] WS message type: status {...}
[TablePreview] WS message type: execution_start {...}
[TablePreview] WS message type: executing {...}

// 3. 关键：执行完成消息
[TablePreview] WS message type: executed {type: "executed", data: {...}}
[TablePreview] Execution message: {type: "executed", data: {node: "2", output: {table: [...]}, prompt_id: "..."}}
[TablePreview] Output data: {table: [...]}
[TablePreview] ✓ Found table data: [{id: "...", title: "...", columns: [...], data: [...]}]

// 4. 表格应该弹出！
```

### 3. 如果看到 "✗ No table data"

```javascript
[TablePreview] ✗ No table data in output
[TablePreview]   output: {...}
[TablePreview]   output.table: undefined
```

**这意味着**：output对象中没有table字段。

#### 调试步骤：

在浏览器控制台手动检查：
```javascript
// 复制最近的 Execution message 对象，然后运行：
let msg = {type: "executed", data: {...}};  // 粘贴你看到的消息
console.log('data:', msg.data);
console.log('output:', msg.data.output);
console.log('table:', msg.data.output?.table);
```

### 4. 检查后端日志

服务器控制台应该显示：

```
[*] Executing node 1: LoadCSV
    [OK] Loaded CSV: 10 rows × 5 cols
[*] Executing node 2: PreviewTable  
    [OK] Preview table: 10 rows × 5 cols
[OK] Node 2 executed successfully
[>>] Sending WebSocket message for node 2
```

**关键**：必须看到 "Sending WebSocket message"

### 5. 如果没有 "Sending WebSocket message"

这意味着节点没有返回UI数据。检查：

```python
# 在table_nodes.py的PreviewTable.execute方法
return {
    "ui": {
        "table": [table_json]  # ← 这个必须存在
    }
}
```

## 🐛 常见问题定位

### 问题A: 没有WebSocket消息

**症状**：只看到加载日志，没有任何WS message

**原因**：WebSocket未连接

**检查**：
1. 浏览器控制台 → Network → WS标签
2. 应该看到 `ws://127.0.0.1:8188/ws` 连接
3. 状态应该是 "Connected"

### 问题B: 有executed消息但没有table

**症状**：
```
[TablePreview] Execution message: {type: "executed", data: {output: {}}}
[TablePreview] ✗ No table data
```

**原因**：节点返回的UI数据为空

**解决**：
1. 检查后端日志是否有错误
2. 确认PreviewTable节点正确接收数据
3. 检查`_to_dataframe`是否成功转换

### 问题C: 数据格式错误

**症状**：
```
[TablePreview] ✓ Found table data: undefined
```

**原因**：table数组为空或格式错误

**检查**：在控制台运行：
```javascript
// 假设msg是Execution message
console.log(msg.data.output.table);
console.log(msg.data.output.table[0]);  // 应该是表格数据对象
```

## 🧪 手动测试 WebSocket

在浏览器控制台运行：

```javascript
// 1. 监听所有WebSocket消息
const originalWS = window.WebSocket;
window.WebSocket = function(url, protocols) {
    const ws = new originalWS(url, protocols);
    ws.addEventListener('message', (e) => {
        try {
            const data = JSON.parse(e.data);
            if (data.type === 'executed') {
                console.log('=== EXECUTED MESSAGE ===');
                console.log('Full:', data);
                console.log('Node:', data.data.node);
                console.log('Output:', data.data.output);
                console.log('Table:', data.data.output?.table);
                console.log('=======================');
            }
        } catch(e) {}
    });
    return ws;
};

// 2. 然后刷新页面，重新运行工作流
```

## 📊 预期数据结构

### WebSocket消息格式：

```json
{
  "type": "executed",
  "data": {
    "node": "2",
    "output": {
      "table": [
        {
          "id": "uuid",
          "title": "Data Table",
          "columns": ["Name", "Age", "City", "Salary", "Department"],
          "data": [
            ["Alice", 28, "New York", 75000, "Engineering"],
            ["Bob", 35, "San Francisco", 95000, "Engineering"]
          ],
          "shape": [10, 5],
          "dtypes": {"Name": "object", "Age": "int64", ...},
          "truncated": false,
          "total_rows": 10
        }
      ]
    },
    "prompt_id": "prompt-..."
  }
}
```

### 节点返回格式（后端）：

```python
return {
    "ui": {
        "table": [table_json]
    }
}
```

## 🔧 临时修复测试

如果还是不显示，在浏览器控制台手动触发：

```javascript
// 创建测试数据
const testTable = {
    id: "test",
    title: "Test Table",
    columns: ["A", "B", "C"],
    data: [[1, 2, 3], [4, 5, 6]],
    shape: [2, 3],
    dtypes: {"A": "int", "B": "int", "C": "int"},
    truncated: false,
    total_rows: 2
};

// 手动调用显示函数（需要扩展已加载）
// 在控制台应该能找到showTableModal函数
// 如果不能，说明扩展作用域问题

// 临时解决：直接注入显示代码
(function() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1e1e1e;padding:20px;z-index:10000;border:2px solid #444;';
    modal.innerHTML = '<h3 style="color:#fff;">Test Table</h3><pre style="color:#fff;">' + JSON.stringify(testTable, null, 2) + '</pre>';
    document.body.appendChild(modal);
    modal.onclick = () => modal.remove();
})();
```

## ✅ 成功标志

当一切正常时，你应该看到：

1. ✅ 扩展加载成功
2. ✅ WebSocket连接建立
3. ✅ 收到executed消息
4. ✅ 找到table数据
5. ✅ 表格弹窗自动显示
6. ✅ 数据正确渲染

---

**如果问题仍然存在，请提供浏览器控制台的完整输出！**

