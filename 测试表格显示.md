# 测试表格显示功能

## 🧪 测试步骤

### 1. 启动服务器

```bash
python full_server.py
```

查看启动日志，确认：
```
[OK] Loaded 4 table nodes: ['PreviewTable', 'LoadCSV', 'LoadExcel', 'DataFrameToTable']
[OK] Loaded web_extensions from: ...
[OK] Injected 1 extension script(s)
[>>] Web extensions: 1 file(s) loaded
[>>] Server running at: http://127.0.0.1:8188
```

### 2. 打开浏览器

访问：`http://127.0.0.1:8188`

### 3. 打开浏览器控制台

按 **F12**，切换到 **Console** 标签

应该看到：
```
[TablePreview] Loading table preview extension...
[TablePreview] ComfyUI loaded, registering extension...
[TablePreview] Using event-based API
  或
[TablePreview] Using direct monitoring
[TablePreview] WebSocket monitoring active
```

### 4. 创建测试工作流

#### 方法A：加载CSV文件

1. 添加节点 `LoadCSV`
2. 设置参数：
   - `file_path`: `examples/sample_data.csv`
3. 添加节点 `PreviewTable`
4. 连接：`LoadCSV` → `PreviewTable`
5. 点击 **Queue Prompt**

#### 方法B：使用Python测试数据

如果你有Python节点，可以：

```python
import pandas as pd

# 创建测试数据
data = pd.DataFrame({
    "Name": ["Alice", "Bob", "Charlie"],
    "Age": [25, 30, 35],
    "City": ["NY", "LA", "SF"]
})

return {"result": (data,)}
```

然后连接到 `PreviewTable`。

### 5. 验证结果

#### 后端日志（控制台）
```
[*] Executing node 1: LoadCSV
    [OK] Loaded CSV: 10 rows × 5 cols
[*] Executing node 2: PreviewTable
    [OK] Preview table: 10 rows × 5 cols
[OK] Node 2 executed successfully
```

#### 前端日志（浏览器F12）
```
[TablePreview] Received table data: {...}
  或
[TablePreview] Received table via WebSocket: {...}
```

#### 表格显示
应该自动弹出一个**暗色主题的表格窗口**，显示数据。

### 6. 交互测试

- ✅ 表格正确显示所有数据
- ✅ 列头显示数据类型
- ✅ 行号正确
- ✅ 可以滚动查看
- ✅ 点击"关闭"按钮可关闭
- ✅ 点击背景遮罩可关闭
- ✅ 按ESC键可关闭

## 🐛 故障排除

### 问题1: 扩展未加载

**症状**：控制台没有 `[TablePreview]` 日志

**解决**：
1. 检查服务器启动日志是否显示扩展加载
2. 强制刷新浏览器（Ctrl+Shift+R）
3. 重启服务器

### 问题2: "app.registerExtension is not a function"

**症状**：看到这个错误

**解决**：
- 已修复！确保使用最新版本的 `tablePreview.js`
- 如果还有问题，运行：
  ```bash
  git pull
  # 或
  git checkout tablePreview.js
  ```

### 问题3: 表格不显示

**症状**：节点执行成功，但没有弹出表格

**调试步骤**：

1. **检查后端输出**：
   ```
   [OK] Preview table: X rows × Y cols
   ```
   如果没有这个，说明数据没到达PreviewTable节点。

2. **检查前端控制台**：
   ```
   [TablePreview] Received table data: ...
   ```
   如果没有这个，说明前端没有接收到消息。

3. **检查WebSocket连接**：
   - 在浏览器控制台查看 Network → WS标签
   - 确认有WebSocket连接到 `ws://127.0.0.1:8188/ws`

4. **查看消息格式**：
   在控制台运行：
   ```javascript
   // 监听所有消息
   const ws = new WebSocket('ws://127.0.0.1:8188/ws');
   ws.onmessage = (e) => console.log('WS:', e.data);
   ```

### 问题4: 表格数据为空

**症状**：弹窗显示"Empty data"或"No data"

**检查**：
1. LoadCSV文件路径是否正确
2. CSV文件是否为空
3. 数据格式是否正确（应该是DataFrame或兼容格式）

### 问题5: Tuple错误

**症状**：`Unsupported data type: tuple`

**解决**：
- 已修复！更新到最新版本
- 如果还有问题：
  ```bash
  git pull
  ```

## 📊 预期输出示例

### 成功的完整流程：

#### 1. 服务器启动
```
[OK] Loaded 4 table nodes: ['PreviewTable', 'LoadCSV', 'LoadExcel', 'DataFrameToTable']
[OK] Loaded web_extensions from: C:\...\simple_comfyui\web_extensions
[OK] Injected 1 extension script(s)
[>>] Web extensions: 1 file(s) loaded
[>>] Server running at: http://127.0.0.1:8188
```

#### 2. 浏览器控制台
```
[TablePreview] Loading table preview extension...
[TablePreview] ComfyUI loaded, registering extension...
[TablePreview] WebSocket monitoring active
```

#### 3. 执行工作流
```
[*] Executing node 1: LoadCSV
    [OK] Loaded CSV: 10 rows × 5 cols
[*] Executing node 2: PreviewTable
    [OK] Preview table: 10 rows × 5 cols
[OK] Node 2 executed successfully
```

#### 4. 浏览器控制台
```
[TablePreview] Received table via WebSocket: Object
```

#### 5. 表格弹窗显示
- 暗色主题
- 标题："Data Table" 或自定义标题
- 显示："10 rows × 5 columns"
- 完整表格数据

## ✅ 测试清单

- [ ] 服务器成功启动
- [ ] 扩展成功加载（日志确认）
- [ ] 浏览器控制台无错误
- [ ] LoadCSV节点执行成功
- [ ] PreviewTable节点执行成功
- [ ] 表格弹窗自动显示
- [ ] 数据正确显示
- [ ] 可以关闭弹窗
- [ ] 可以滚动查看数据

## 📝 报告问题

如果测试失败，请提供：

1. **服务器启动日志**（完整）
2. **浏览器控制台日志**（F12 → Console）
3. **工作流配置**（节点和连接）
4. **错误截图**（如果有）

---

**祝测试顺利！** 🎉

