# ComfyUI 简化版 - 使用指南

> 详细的使用说明和操作指南

## 📁 文件说明

### 核心文件（必需）

| 文件 | 大小 | 说明 |
|------|------|------|
| `full_server.py` | 21.1 KB | ⭐ 完整功能服务器（推荐使用） |
| `nodes.py` | 11.9 KB | 节点定义系统 |
| `requirements.txt` | 0.3 KB | Python依赖包列表 |
| `START_FULL.bat` | 0.3 KB | 快速启动脚本 |

### 备用文件（可选）

| 文件 | 大小 | 说明 |
|------|------|------|
| `simple_server.py` | 22.1 KB | 简化版服务器 |
| `modular_server.py` | 20.3 KB | 模块化服务器 |
| `start_modular.bat` | 0.3 KB | 模块化服务器启动脚本 |

### 文档文件

| 文件 | 说明 |
|------|------|
| `README.md` | 快速开始指南 |
| `使用指南.md` | 本文件 - 详细使用说明 |
| `项目说明.md` | 项目结构和状态 |
| `FULL_FEATURES.md` | 完整功能文档（英文） |

### 自动创建的目录

| 目录 | 用途 |
|------|------|
| `input/` | 输入图片目录 |
| `output/` | 输出结果目录 |
| `temp/` | 临时预览图片目录 |

## 🚀 快速开始

### 方法1：双击启动（推荐）

```
双击 START_FULL.bat
```

### 方法2：命令行启动

```bash
python full_server.py
```

### 访问地址

```
http://127.0.0.1:8188
```

## 📦 安装依赖

### 首次使用

```bash
pip install -r requirements.txt
```

### 主要依赖

```
aiohttp          # Web服务器
Pillow           # 图片处理
comfyui-frontend-package  # 官方前端界面
```

## 🎯 功能特点

### ✅ 完整的节点系统

#### 图片处理节点

| 节点 | 功能 | 输入 | 输出 |
|------|------|------|------|
| `LoadImage` | 加载图片 | 图片路径 | IMAGE |
| `SaveImage` | 保存图片 | IMAGE | - |
| `ImageScale` | 图片缩放 | IMAGE, 宽, 高 | IMAGE |
| `PreviewImage` | 预览图片 | IMAGE | - |

#### 基础类型节点

| 节点 | 功能 | 输出 |
|------|------|------|
| `PrimitiveFloat` | 浮点数 | FLOAT |
| `PrimitiveString` | 字符串 | STRING |

#### 高级节点

| 节点 | 功能 |
|------|------|
| `LatentBlend` | 潜在空间混合 |
| `VAEDecode` | VAE解码 |
| `PreviewAny` | 预览任意类型 |
| `Reroute` | 重路由连接 |
| `Note` | 添加注释 |
| `MarkdownNote` | Markdown注释 |

### ✅ 工作流执行引擎

- **拓扑排序** - 自动按依赖关系排序节点
- **智能数据传递** - 自动匹配输入输出类型
- **错误处理** - 捕获并报告节点执行错误
- **循环依赖检测** - 防止无限循环
- **保留原始对象** - PIL Image等对象在节点间直接传递

### ✅ WebSocket实时通信

- **实时连接管理** - 自动管理客户端连接
- **广播消息** - 同时推送给所有客户端
- **executed事件** - 节点执行完成通知
- **图片预览** - 实时显示PreviewImage结果

### ✅ 图片处理系统

- **`/view` API** - 查看图片
- **三个目录支持** - `output/`, `input/`, `temp/`
- **子文件夹支持** - 支持多级目录
- **安全路径检查** - 防止目录遍历攻击
- **PreviewImage自动保存** - 自动保存到temp目录

### ✅ 完整的API端点

#### 核心API

```
POST /prompt              - 执行工作流
GET  /object_info         - 获取所有节点信息
GET  /queue               - 队列状态
GET  /history             - 历史记录
GET  /history/{prompt_id} - 特定历史
GET  /embeddings          - 嵌入列表
GET  /extensions          - 扩展列表
GET  /system_stats        - 系统状态
GET  /ws                  - WebSocket连接
```

#### 用户API

```
GET/POST /users           - 用户管理
GET/POST /user_config     - 用户配置
GET/POST /settings        - 设置
GET/POST /settings/{key}  - 特定设置
GET      /userdata        - 用户数据
```

#### 其他API

```
GET /api/i18n             - 国际化（中文支持）
GET /api/experiment/models - 实验模型
GET /api/workflows        - 工作流列表
GET /api/entities         - 实体列表
GET /manifest.json        - PWA清单
GET /user.css             - 用户CSS
GET /view                 - 查看图片
```

## 🔧 使用示例

### 示例1：图片预览

**步骤：**

1. 添加 `LoadImage` 节点
2. 添加 `PreviewImage` 节点
3. 连接：`LoadImage` → `PreviewImage`
4. 点击 "Queue Prompt" 运行
5. 图片会实时显示在PreviewImage节点中

**工作流：**

```
LoadImage → PreviewImage
```

**说明：**
- LoadImage从`input/`目录加载图片
- PreviewImage通过WebSocket实时显示
- 图片保存在`temp/`目录

### 示例2：图片缩放保存

**步骤：**

1. 添加 `LoadImage` 节点
2. 添加 `ImageScale` 节点
   - 设置宽度：512
   - 设置高度：512
3. 添加 `SaveImage` 节点
4. 连接：`LoadImage` → `ImageScale` → `SaveImage`
5. 运行后查看 `output/` 目录

**工作流：**

```
LoadImage → ImageScale → SaveImage
```

**说明：**
- ImageScale调整图片大小
- SaveImage保存到`output/`目录
- 文件名格式：`ComfyUI_00001_.png`

### 示例3：多输出工作流

**工作流：**

```
LoadImage → ImageScale → PreviewImage
          ↓
       SaveImage
```

**说明：**
- ImageScale的输出同时连接到两个节点
- PreviewImage实时预览
- SaveImage保存结果

### 示例4：使用基础类型

**工作流：**

```
PrimitiveFloat → ImageScale (width)
PrimitiveFloat → ImageScale (height)
LoadImage → ImageScale → SaveImage
```

**说明：**
- 使用PrimitiveFloat节点提供宽高参数
- 可以动态调整参数

## 📂 目录说明

### input/ 目录

**用途：** 放置输入图片

**支持格式：**
- PNG
- JPG / JPEG
- BMP
- GIF

**使用方法：**
1. 将图片复制到`input/`目录
2. 在LoadImage节点中选择图片

### output/ 目录

**用途：** 保存输出结果

**文件命名：**
- 格式：`{prefix}_{counter}_.png`
- 示例：`ComfyUI_00001_.png`

**使用方法：**
1. SaveImage节点自动保存
2. 可以设置filename_prefix参数

### temp/ 目录

**用途：** 临时预览图片

**特点：**
- PreviewImage节点自动保存
- 用于WebSocket实时显示
- 文件名包含随机字符串

**清理：**
- 可以定期手动清理
- 不影响工作流执行

## 🐛 常见问题

### Q1: 端口8188被占用？

**问题：**
```
OSError: [Errno 10048] error while attempting to bind on address
```

**解决方法：**

```powershell
# Windows PowerShell
Get-Process python | Stop-Process -Force
```

或者修改端口：

```python
# 在 full_server.py 中
site = web.TCPSite(runner, '127.0.0.1', 8188)
#                                        ^^^^
#                                        改成其他端口
```

### Q2: 页面空白或404错误？

**可能原因：**
1. 前端包未安装
2. 浏览器缓存
3. 路由配置错误

**解决方法：**

```bash
# 1. 确认前端包已安装
pip install comfyui-frontend-package

# 2. 强制刷新浏览器
按 Ctrl+Shift+R

# 3. 检查服务器日志
查看控制台输出
```

### Q3: 图片不显示？

**检查清单：**

1. **input/目录是否有图片？**
   ```bash
   ls input/
   ```

2. **浏览器Console有错误？**
   - 按F12打开开发者工具
   - 查看Console标签

3. **服务器日志有错误？**
   - 查看控制台输出
   - 查找`[X]`标记的错误

4. **图片路径正确？**
   - LoadImage节点的路径
   - 相对于input/目录

### Q4: 节点执行失败？

**查看日志：**

服务器控制台会显示：
```
[>>] 信息日志
[*]  执行日志
[OK] 成功日志
[X]  错误日志
```

**常见错误：**

1. **图片未找到**
   ```
   [X] Not found: input/test.png
   ```
   解决：检查文件是否存在

2. **节点类型未知**
   ```
   [X] Unknown node type: XXX
   ```
   解决：检查节点名称拼写

3. **输入数据错误**
   ```
   [X] Cannot find valid PIL Image object
   ```
   解决：检查节点连接是否正确

### Q5: WebSocket连接失败？

**检查：**

1. 浏览器Network标签
   - 筛选WS
   - 查看连接状态

2. 服务器日志
   ```
   [>>] WebSocket client connected
   ```

3. 防火墙设置
   - 允许8188端口

## 🔍 调试技巧

### 1. 查看服务器日志

**日志格式：**

```
[>>] 信息日志 - 一般信息
[*]  执行日志 - 节点执行
[OK] 成功日志 - 操作成功
[X]  错误日志 - 错误信息
```

**示例：**

```
[>>] Received workflow request
[*] Executing node 1: LoadImage
    [OK] Loaded: input/test.png (1024x768)
[*] Executing node 2: PreviewImage
    [OK] Preview saved: temp/ComfyUI_temp_abc12_00001_.png
[OK] Workflow completed!
```

### 2. 查看浏览器Console

**打开方式：**
- 按 `F12`
- 或右键 → 检查

**查看内容：**
- JavaScript错误
- API请求
- WebSocket消息

### 3. 查看Network请求

**开发者工具 → Network标签**

**筛选：**
- `XHR` - API请求
- `WS` - WebSocket连接
- `Img` - 图片加载

**查看：**
- 请求URL
- 响应状态码
- 响应内容

### 4. 测试API

**使用curl：**

```bash
# 测试节点信息
curl http://127.0.0.1:8188/object_info

# 测试系统状态
curl http://127.0.0.1:8188/system_stats

# 测试队列
curl http://127.0.0.1:8188/queue
```

## 📝 开发说明

### 添加自定义节点

**步骤：**

1. 在`nodes.py`中创建新类：

```python
class MyCustomNode(NodeBase):
    def __init__(self):
        super().__init__()
        self.name = "MyCustomNode"
        self.category = "custom"
        self.icon = "🎨"
        self.inputs = ["STRING"]
        self.outputs = ["STRING"]
        self.description = "My custom node"
    
    def get_node_info(self):
        return {
            "input": {
                "required": {
                    "text": ["STRING", {"default": ""}]
                }
            },
            "output": ["STRING"],
            "output_is_list": [False],
            "output_name": ["STRING"],
            "name": "MyCustomNode",
            "display_name": "My Custom Node",
            "description": "My custom node",
            "category": "custom",
            "output_node": False
        }
    
    def execute(self, inputs, node_id):
        text = inputs.get("text", "")
        result = text.upper()  # 你的逻辑
        return {"STRING": result}
```

2. 节点会自动注册到系统

3. 重启服务器

4. 在前端添加节点

### 修改端口

**在`full_server.py`中：**

```python
site = web.TCPSite(runner, '127.0.0.1', 8188)
#                                        ^^^^
#                                        改成其他端口
```

### 修改目录

**在`full_server.py`中：**

```python
INPUT_DIR = Path("input")
OUTPUT_DIR = Path("output")
TEMP_DIR = Path("temp")
```

## ⚠️ 注意事项

### 不要删除

- `full_server.py` - 核心服务器
- `nodes.py` - 节点系统
- `requirements.txt` - 依赖列表

### 使用建议

1. 首次运行需要安装依赖
2. 确保端口8188未被占用
3. `input/`目录需要有测试图片
4. 使用`Ctrl+C`正常停止服务器
5. 定期清理`temp/`目录

### 性能建议

1. 图片不要太大（建议<4K）
2. 工作流不要太复杂
3. 定期清理历史记录

## 📚 相关文档

- **README.md** - 快速开始
- **项目说明.md** - 项目结构
- **FULL_FEATURES.md** - 完整功能文档

---

**祝使用愉快！** 🎉

