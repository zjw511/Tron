# 信号分析器使用指南

## 🚀 快速开始（5分钟上手）

### 第一步：启动服务器

```bash
# Windows：双击运行
START_FULL.bat

# 或命令行
python full_server.py
```

等待看到：
```
[OK] Signal processing nodes loaded successfully
[OK] Total nodes: 19
[>>] Server running at: http://127.0.0.1:8188
```

### 第二步：打开浏览器

访问：`http://127.0.0.1:8188`

---

## 📡 基础工作流：接收并查看数据

### 最简单的流程（推荐新手）

```
NetworkReceiver → RawDataSaver
```

**操作步骤**：

1. **右键点击画布** → Add Node → signal/input → **NetworkReceiver**
   - protocol: UDP
   - port: 8888
   - continuous: true
   - buffer_size: 65536

2. **右键点击画布** → Add Node → signal/output → **RawDataSaver**
   - filename: test_data
   - save_format: both
   - auto_timestamp: true

3. **连接节点**：拖动 NetworkReceiver 的输出端口到 RawDataSaver 的输入端口

4. **点击 "Queue Prompt"** 运行

5. **发送测试数据**（另一个终端）：
   ```bash
   python send_signal_data.py
   ```
   选择 "1" 快速启动

6. **查看结果**：
   - 检查 `output/` 目录
   - 如果有 `.hex` 和 `.bin` 文件生成 → ✅ 数据接收成功！
   - 用记事本打开 `.hex` 文件查看数据

---

## 📊 进阶工作流：完整信号分析

### 工作流1：频谱分析

```
NetworkReceiver → DataBuffer → FrameParser → DataConverter → SpectrumAnalyzer → PreviewImage
                      ↓
                  BufferMonitor → PreviewImage
```

**节点配置**：

1. **NetworkReceiver**
   - protocol: UDP
   - port: 8888
   - continuous: true

2. **DataBuffer** 📦
   - buffer_id: "main"
   - max_size: 100
   - mode: queue

3. **BufferMonitor** 📊
   - show_chart: true
   - 连接到另一个 PreviewImage

4. **FrameParser**
   - frame_header: "0xAA55"
   - header_size: 16
   - byte_order: little

5. **DataConverter**
   - data_format: IQ_INT16
   - sample_rate: 2400000
   - center_frequency: 1575000000

6. **SpectrumAnalyzer**
   - fft_size: 1024
   - window: hanning
   - log_scale: true

7. **PreviewImage** × 2
   - 一个显示频谱图
   - 一个显示缓冲区监控图表

**运行效果**：
- 实时显示信号频谱图
- 实时监控数据流状态
- 控制台显示详细统计

---

### 工作流2：星座图分析

```
NetworkReceiver → FrameParser → DataConverter → ConstellationDiagram → PreviewImage
```

**关键配置**：

**ConstellationDiagram**:
- max_points: 10000
- normalize: true
- show_density: true
- width: 800
- height: 800

**运行效果**：
- 显示信号的IQ星座图
- 可以看到调制方式（QPSK、QAM等）

---

### 工作流3：完整信号监控

```
NetworkReceiver
    ↓
DataBuffer (缓冲管理)
    ├→ BufferMonitor → PreviewImage (监控图表)
    └→ FrameParser
         ↓
    DataConverter
         ├→ SpectrumAnalyzer → PreviewImage (频谱图)
         ├→ ConstellationDiagram → PreviewImage (星座图)
         ├→ SignalClassifier
         ├→ SymbolRateAnalyzer
         └→ SignalMonitor (控制台输出)
```

**效果**：
- 3个可视化窗口（缓冲区、频谱、星座）
- 自动识别信号类型
- 估计符号速率
- 控制台显示完整信息

---

## ⚠️ 重要提示：节点输出位置

不同节点的输出显示在不同位置：

| 输出类型 | 显示位置 | 节点示例 |
|---------|---------|---------|
| 📊 **图像输出** | **浏览器** | SignalInfoImage, SpectrumAnalyzer, ConstellationDiagram, BufferMonitor |
| 📺 **文本输出** | **服务器控制台** | SignalMonitor |
| 💾 **文件输出** | **output/ 目录** | RawDataSaver |

**💡 提示**：
- ⭐ **推荐**: 使用 **SignalInfoImage** 在浏览器中查看完整信号信息！
- 如果要在**浏览器**中看结果 → 使用图像节点 + PreviewImage
- 如果要在**控制台**中看详细信息 → 查看运行 `full_server.py` 的终端窗口
- 如果要**保存数据**到文件 → 使用 RawDataSaver

---

## 🔧 节点功能速查

### 数据接收类

| 节点 | 功能 | 输出 |
|------|------|------|
| 📡 NetworkReceiver | UDP/TCP接收 | RAW_DATA |
| 📦 DataBuffer | 数据缓冲 | RAW_DATA + BUFFER_STATS |

### 数据处理类

| 节点 | 功能 | 输入 → 输出 |
|------|------|------------|
| 🔍 FrameParser | 解析帧结构 | RAW_DATA → FRAME |
| 🔄 DataConverter | 数据格式转换 | FRAME → SIGNAL_DATA |
| 🎯 SignalClassifier | 信号分类 | SIGNAL_DATA → SIGNAL_DATA |
| ⏱️ SymbolRateAnalyzer | 符号速率 | SIGNAL_DATA → SIGNAL_DATA |
| 🧭 AzimuthProcessor | 方位角 | SIGNAL_DATA → SIGNAL_DATA + IMAGE |
| 📶 FrequencyDetector | 频点检测 | SIGNAL_DATA → SIGNAL_DATA + IMAGE |

### 可视化类

| 节点 | 功能 | 输入 → 输出 |
|------|------|------------|
| 📈 SpectrumAnalyzer | 频谱图 | SIGNAL_DATA → IMAGE |
| ⭐ ConstellationDiagram | 星座图 | SIGNAL_DATA → IMAGE |
| 📊 BufferMonitor | 缓冲区监控 | BUFFER_STATS → IMAGE |
| 📋 **SignalInfoImage** | 信号信息面板 | SIGNAL_DATA → IMAGE ⭐ NEW |

### 输出类

| 节点 | 功能 | 作用 |
|------|------|------|
| 📺 SignalMonitor | 信号监视 | 控制台显示详细信息 |
| 📋 **SignalInfoImage** | 信号信息面板 | 浏览器显示完整信息 ⭐ NEW |
| 💾 RawDataSaver | 数据保存 | 保存原始数据到文件 |

---

## 💡 常见使用场景

### 场景1：调试 - 检查是否收到数据

**最简工作流**：
```
NetworkReceiver → RawDataSaver
```

**操作**：
1. 运行工作流
2. 发送测试数据
3. 检查 `output/` 目录
4. 打开 `.hex` 文件查看

**判断**：
- ✅ 有文件 → 接收正常
- ❌ 无文件 → 检查端口/网络

---

### 场景2：实时监控 - 查看数据流状态

**工作流**：
```
NetworkReceiver → DataBuffer → BufferMonitor → PreviewImage
                      ↓
                  FrameParser → ...
```

**查看**：
- 接收了多少数据
- 发送了多少数据
- 有没有丢包
- 缓冲区使用率

---

### 场景3：信号分析 - 查看频谱和星座图

**工作流**：
```
NetworkReceiver → FrameParser → DataConverter
                                      ├→ SpectrumAnalyzer → PreviewImage
                                      └→ ConstellationDiagram → PreviewImage
```

**分析**：
- 频谱图：看频率成分、带宽
- 星座图：看调制方式、噪声

---

### 场景4：自动识别 - 判断信号类型（浏览器版）⭐ 推荐

**工作流**：
```
NetworkReceiver → FrameParser → DataConverter → SignalClassifier → SignalInfoImage → PreviewImage
```

**输出**（浏览器）：
- 显示一个美观的信号信息面板
- 包含所有参数：频率、功率、信号类型、符号速率等
- 支持深色/浅色主题

**优势**：
- ✅ 直接在浏览器查看
- ✅ 无需切换到控制台窗口
- ✅ 可以截图保存

---

### 场景5：自动识别 - 控制台版

**工作流**：
```
NetworkReceiver → FrameParser → DataConverter → SignalClassifier → SignalMonitor
```

**输出**（控制台）：
```
信号类型:   PSK
符号速率:   240.00 kSps
信号功率:   -12.34 dB
```

---

## 🎯 实战演练

### 任务：分析QPSK信号

**步骤**：

1. **启动ComfyUI**
   ```bash
   python full_server.py
   ```

2. **创建工作流**（在浏览器中）：
   ```
   NetworkReceiver (port=8888)
       ↓
   DataBuffer (buffer_id="qpsk", max_size=50)
       ├→ BufferMonitor → PreviewImage
       └→ FrameParser (header="0xAA55")
            ↓
       DataConverter (format=IQ_INT16, sample_rate=2.4MHz)
            ├→ SignalInfoImage → PreviewImage  ⭐ 新增：浏览器显示信息
            ├→ SpectrumAnalyzer → PreviewImage
            ├→ ConstellationDiagram → PreviewImage
            └→ SignalClassifier → SignalMonitor
   ```

3. **运行工作流**
   - 点击 "Queue Prompt"

4. **发送QPSK数据**（新终端）：
   ```bash
   python send_signal_data.py
   ```
   - 选择 "2" 交互模式
   - 选择 "1" QPSK信号
   - 目标端口：8888
   - 发送间隔：1秒

5. **查看结果**：
   - **信号信息面板**：浏览器中查看完整信号参数 ⭐ NEW
   - **缓冲区监控图**：查看数据流状态
   - **频谱图**：看到QPSK信号的频谱特征
   - **星座图**：看到4个点的QPSK星座
   - **控制台**：显示识别结果

**预期输出**（控制台）：
```
[Buffer qpsk] Received: 2048 bytes, Queue: 15/50
[Buffer qpsk] Sent: 2048 bytes, Queue: 14/50

    [OK] Converted 1024 samples, Power=1.00e-02
    [OK] Signal classified as: PSK

    ═══════════════════════════════════════
    📺 信号监视器
    ═══════════════════════════════════════
    中心频率:   1575.000 MHz
    采样率:     2.400 MSps
    信号功率:   -20.00 dB
    信号类型:   PSK
    符号速率:   600.00 kSps
    方位角:     45.0°
    样本数:     1024
    ═══════════════════════════════════════
```

---

## 🔍 故障排查

### Q1: 没有数据显示

**检查清单**：
1. ✅ 服务器正在运行？
2. ✅ 点击了 "Queue Prompt"？
3. ✅ NetworkReceiver端口配置正确？
4. ✅ 有程序发送数据？

**解决方案**：
```bash
# 发送测试数据
python send_signal_data.py
```

---

### Q2: 图像不刷新

**原因**：ComfyUI需要手动运行工作流

**解决方案**：
- 每次需要更新时点击 "Queue Prompt"
- 或设置为自动运行模式

---

### Q3: 中文显示为方框

**原因**：已自动修复

**确认**：启动时应该看到
```
[OK] Configured matplotlib Chinese font: Microsoft YaHei
```

---

### Q4: 缓冲区一直满

**原因**：处理速度 < 接收速度

**解决方案**：
- 增大 DataBuffer 的 max_size
- 优化后续节点
- 降低发送频率

---

### Q5: SignalMonitor 没有显示 ⭐ 重要

**原因**：SignalMonitor 的输出在服务器控制台，不在浏览器！

**解决方案**：

**方法1 - 查看控制台**（推荐）
- 找到运行 `python full_server.py` 的终端窗口
- 在那个黑色窗口中查看输出
- 每次执行工作流时会打印信号信息

**方法2 - 使用 SignalInfoImage**（⭐ 强烈推荐）
```
DataConverter → SignalInfoImage → PreviewImage
```
**SignalInfoImage** 是专门为浏览器显示设计的信号信息面板！

**特性**：
- ✅ 在浏览器中显示完整的信号信息
- ✅ 美观的图像面板，易于阅读
- ✅ 支持深色/浅色主题 (theme: dark/light)
- ✅ 可调节字体大小 (font_size: 10-24)
- ✅ 包含所有参数：频率、功率、信号类型、符号速率等

**方法3 - 组合使用**（最全面）
```
DataConverter
    ├→ SignalInfoImage → PreviewImage        ← 浏览器看完整信息 ⭐
    ├→ SpectrumAnalyzer → PreviewImage       ← 浏览器看频谱图
    ├→ ConstellationDiagram → PreviewImage   ← 浏览器看星座图
    └→ SignalMonitor                         ← 控制台看详细日志
```

这样可以同时在浏览器和控制台看到信息！

---

## 📚 相关文档

- **完整文档**: `BUFFER_使用说明.md`
- **数据保存**: `RAWDATA_SAVER_使用说明.md`
- **README**: 项目总览
- **发送数据**: `SEND_SIGNAL_README.md`

---

## ✅ 学习路径

### 初级（第1天）
1. ✅ 启动服务器
2. ✅ 创建 NetworkReceiver → RawDataSaver
3. ✅ 发送测试数据
4. ✅ 查看保存的文件

### 中级（第2-3天）
1. ✅ 添加 FrameParser 和 DataConverter
2. ✅ 显示频谱图
3. ✅ 显示星座图
4. ✅ 使用 DataBuffer 监控数据流

### 高级（第4-7天）
1. ✅ 完整工作流（多个可视化）
2. ✅ 自动识别信号类型
3. ✅ 方位角和频点检测
4. ✅ 多级缓冲和监控

---

## 🎉 快速参考卡

### 最常用的3个工作流

**1. 数据接收测试**
```
NetworkReceiver → RawDataSaver
```

**2. 频谱分析**
```
NetworkReceiver → FrameParser → DataConverter → SpectrumAnalyzer → PreviewImage
```

**3. 完整监控（包含信息面板）**⭐ 推荐
```
NetworkReceiver → DataBuffer → BufferMonitor → PreviewImage
                      ↓
                  FrameParser → DataConverter
                                    ├→ SignalInfoImage → PreviewImage  ⭐ NEW
                                    ├→ SpectrumAnalyzer → PreviewImage
                                    └→ ConstellationDiagram → PreviewImage
```

### 必记参数

**NetworkReceiver**:
- port: 8888
- continuous: true
- buffer_size: 65536

**DataConverter**:
- data_format: IQ_INT16
- sample_rate: 2400000 (2.4MHz)

**SpectrumAnalyzer**:
- fft_size: 1024
- log_scale: true

**SignalInfoImage** ⭐ NEW:
- theme: dark (或 light)
- font_size: 14

---

## 💪 现在就开始！

1. **启动**: `python full_server.py`
2. **浏览器**: `http://127.0.0.1:8188`
3. **右键**: Add Node → signal/...
4. **连接**: 拖动端口连接节点
5. **运行**: 点击 "Queue Prompt"
6. **发送**: `python send_signal_data.py`

🚀 **祝您分析愉快！**

---

**版本**: v1.2.0  
**更新**: 2025-10-26  
**状态**: ✅ 完整指南

